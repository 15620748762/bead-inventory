<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <meta name="format-detection" content="telephone=no">
    <title>æ‹¼è±†åº“å­˜ç®¡ç†</title>
    <style>
        /* æç®€é£æ ¼ï¼Œé¿å…CSSé—®é¢˜ */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: rgba(0,0,0,0);
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Helvetica Neue", sans-serif;
            font-size: 16px;
            background: #f5f5f7;
            color: #333;
            padding: 15px;
            line-height: 1.4;
            -webkit-text-size-adjust: 100%;
            touch-action: manipulation;
        }
        
        .container {
            max-width: 800px;
            margin: 0 auto;
        }
        
        /* å¤´éƒ¨ */
        .header {
            background: #007AFF;
            color: white;
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 20px;
            text-align: center;
        }
        
        .header h1 {
            font-size: 22px;
            margin-bottom: 5px;
        }
        
        .header p {
            font-size: 14px;
            opacity: 0.9;
        }
        
        /* æ ‡ç­¾é¡µ */
        .tabs {
            display: flex;
            background: white;
            border-radius: 10px;
            overflow: hidden;
            margin-bottom: 20px;
        }
        
        .tab-btn {
            flex: 1;
            padding: 15px;
            border: none;
            background: white;
            color: #666;
            font-size: 16px;
            cursor: pointer;
            text-align: center;
            -webkit-appearance: none;
        }
        
        .tab-btn.active {
            background: #007AFF;
            color: white;
            font-weight: 600;
        }
        
        /* å†…å®¹åŒºåŸŸ */
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
        }
        
        /* æœç´¢æ¡† */
        .search-box {
            margin-bottom: 15px;
        }
        
        .search-input {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid #ddd;
            border-radius: 25px;
            font-size: 16px;
            background: white;
            -webkit-appearance: none;
        }
        
        /* é¢œè‰²ç½‘æ ¼ - ç®€å•åˆ—è¡¨å¸ƒå±€ */
        .color-list {
            margin-bottom: 30px;
        }
        
        .color-item {
            background: white;
            padding: 15px;
            margin-bottom: 10px;
            border-radius: 10px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .color-item.low {
            border-left: 4px solid #FF3B30;
        }
        
        .color-id {
            font-weight: bold;
            font-size: 18px;
            margin-bottom: 8px;
            color: #333;
        }
        
        .color-info {
            font-size: 14px;
            color: #666;
            margin-bottom: 10px;
        }
        
        .color-info div {
            margin: 3px 0;
        }
        
        /* æŒ‰é’®ç»„ */
        .btn-group {
            display: flex;
            gap: 8px;
        }
        
        .btn {
            flex: 1;
            padding: 10px;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            text-align: center;
            -webkit-appearance: none;
            user-select: none;
        }
        
        .btn-add {
            background: #34C759;
            color: white;
        }
        
        .btn-edit {
            background: #007AFF;
            color: white;
        }
        
        .btn-use {
            background: #FF9500;
            color: white;
        }
        
        .btn-primary {
            background: #007AFF;
            color: white;
            padding: 15px;
            font-size: 16px;
            font-weight: 600;
            width: 100%;
            border-radius: 10px;
            margin-top: 20px;
            border: none;
            cursor: pointer;
        }
        
        /* è¡¨å• */
        .form-group {
            margin-bottom: 15px;
        }
        
        .form-label {
            display: block;
            margin-bottom: 5px;
            font-weight: 500;
        }
        
        .form-input {
            width: 100%;
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 16px;
            -webkit-appearance: none;
        }
        
        /* é¡¹ç›®åˆ—è¡¨ */
        .project-item {
            background: white;
            padding: 15px;
            margin-bottom: 10px;
            border-radius: 10px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .project-title {
            font-weight: bold;
            font-size: 16px;
            margin-bottom: 5px;
        }
        
        .project-date {
            font-size: 12px;
            color: #999;
            margin-bottom: 10px;
        }
        
        /* æ¨¡æ€æ¡† */
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            display: none;
            z-index: 1000;
            -webkit-overflow-scrolling: touch;
        }
        
        .modal-content {
            background: white;
            margin: 20px;
            padding: 20px;
            border-radius: 12px;
            position: relative;
            top: 50%;
            transform: translateY(-50%);
            max-height: 80vh;
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
        }
        
        /* è­¦æŠ¥ */
        .alert {
            background: #FFE5E5;
            border-left: 4px solid #FF3B30;
            padding: 12px;
            margin-bottom: 15px;
            border-radius: 8px;
            display: none;
        }
        
        .alert.show {
            display: block;
        }
        
        /* åŠ è½½æç¤º */
        .loading {
            text-align: center;
            padding: 20px;
            color: #666;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ§© æ‹¼è±†åº“å­˜ç®¡ç†</h1>
            <p>221ç§é¢œè‰²åº“å­˜ç®¡ç† | é»˜è®¤500é¢—</p>
        </div>
        
        <!-- æ ‡ç­¾å¯¼èˆª -->
        <div class="tabs">
            <button class="tab-btn active" id="btnInventory">åº“å­˜</button>
            <button class="tab-btn" id="btnProject">é¡¹ç›®</button>
            <button class="tab-btn" id="btnStats">ç»Ÿè®¡</button>
        </div>
        
        <!-- åº“å­˜é¡µé¢ -->
        <div id="tabInventory" class="tab-content active">
            <div class="search-box">
                <input type="text" class="search-input" id="searchInput" placeholder="æœç´¢é¢œè‰²ç¼–å·...">
            </div>
            
            <div id="stockAlert" class="alert">
                <div id="alertText"></div>
            </div>
            
            <div id="colorList" class="color-list">
                <div class="loading">åŠ è½½ä¸­...</div>
            </div>
        </div>
        
        <!-- é¡¹ç›®é¡µé¢ -->
        <div id="tabProject" class="tab-content">
            <div style="background: white; padding: 20px; border-radius: 10px; margin-bottom: 20px;">
                <h3 style="margin-bottom: 15px;">æ–°å»ºé¡¹ç›®</h3>
                <div class="form-group">
                    <label class="form-label">é¡¹ç›®åç§°</label>
                    <input type="text" class="form-input" id="projectName" placeholder="è¾“å…¥é¡¹ç›®åç§°">
                </div>
                <div class="form-group">
                    <label class="form-label">é¡¹ç›®æè¿°</label>
                    <textarea class="form-input" id="projectDesc" placeholder="æè¿°é¡¹ç›®ç»†èŠ‚..." rows="3"></textarea>
                </div>
                <div class="form-group">
                    <label class="form-label">é€‰æ‹©ä½¿ç”¨çš„é¢œè‰²</label>
                    <div id="colorSelection" style="max-height: 200px; overflow-y: auto;">
                        <div class="loading">åŠ è½½é¢œè‰²åˆ—è¡¨...</div>
                    </div>
                </div>
                <button class="btn-primary" id="btnCreateProject">åˆ›å»ºé¡¹ç›®</button>
            </div>
            
            <div style="background: white; padding: 20px; border-radius: 10px;">
                <h3 style="margin-bottom: 15px;">å†å²é¡¹ç›®</h3>
                <div id="projectsList">
                    <div class="loading">åŠ è½½é¡¹ç›®åˆ—è¡¨...</div>
                </div>
            </div>
        </div>
        
        <!-- ç»Ÿè®¡é¡µé¢ -->
        <div id="tabStats" class="tab-content">
            <div style="background: white; padding: 20px; border-radius: 10px; margin-bottom: 20px;">
                <h3 style="margin-bottom: 15px;">åº“å­˜ç»Ÿè®¡</h3>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                    <div style="text-align: center;">
                        <div style="font-size: 24px; font-weight: bold; color: #007AFF;" id="statColors">0</div>
                        <div style="font-size: 12px; color: #999;">é¢œè‰²æ€»æ•°</div>
                    </div>
                    <div style="text-align: center;">
                        <div style="font-size: 24px; font-weight: bold; color: #007AFF;" id="statStock">0</div>
                        <div style="font-size: 12px; color: #999;">å½“å‰åº“å­˜</div>
                    </div>
                    <div style="text-align: center;">
                        <div style="font-size: 24px; font-weight: bold; color: #007AFF;" id="statUsed">0</div>
                        <div style="font-size: 12px; color: #999;">æ€»æ¶ˆè€—é‡</div>
                    </div>
                    <div style="text-align: center;">
                        <div style="font-size: 24px; font-weight: bold; color: #FF3B30;" id="statLow">0</div>
                        <div style="font-size: 12px; color: #999;">éœ€è¡¥å……</div>
                    </div>
                </div>
            </div>
            
            <div style="background: white; padding: 20px; border-radius: 10px;">
                <h3 style="margin-bottom: 15px;">éœ€è¡¥å……çš„é¢œè‰²</h3>
                <div id="lowStockList">
                    <div class="loading">åŠ è½½ç»Ÿè®¡ä¿¡æ¯...</div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- åº“å­˜æ“ä½œå¼¹çª— -->
    <div id="stockModal" class="modal">
        <div class="modal-content">
            <h3 style="margin-bottom: 15px;" id="modalTitle">æ“ä½œåº“å­˜</h3>
            <div id="modalContent">
                <div class="loading">åŠ è½½ä¸­...</div>
            </div>
        </div>
    </div>
    
    <!-- é¡¹ç›®ç¼–è¾‘å¼¹çª— -->
    <div id="editModal" class="modal">
        <div class="modal-content">
            <h3 style="margin-bottom: 15px;">ç¼–è¾‘é¡¹ç›®</h3>
            <div id="editContent">
                <div class="loading">åŠ è½½ä¸­...</div>
            </div>
        </div>
    </div>

    <script>
        // ========== å…¼å®¹æ€§ä¿®å¤ ==========
        // ç¡®ä¿åœ¨iOS Safariä¸­localStorageå¯ç”¨
        (function() {
            var isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent) && !window.MSStream;
            var isLocalFile = window.location.protocol === 'file:';
            
            if (isIOS && isLocalFile) {
                console.log('æ£€æµ‹åˆ°iOS Safariè®¿é—®æœ¬åœ°æ–‡ä»¶ï¼Œå¯ç”¨å…¼å®¹æ¨¡å¼');
                
                // ä½¿ç”¨å†…å­˜å­˜å‚¨ä½œä¸ºåå¤‡æ–¹æ¡ˆ
                var memoryStorage = {};
                var safeStorage = {
                    setItem: function(key, value) {
                        try {
                            localStorage.setItem(key, value);
                            memoryStorage[key] = value;
                        } catch(e) {
                            console.log('localStorageä¸å¯ç”¨ï¼Œä½¿ç”¨å†…å­˜å­˜å‚¨');
                            memoryStorage[key] = value;
                        }
                    },
                    getItem: function(key) {
                        try {
                            return localStorage.getItem(key) || memoryStorage[key] || null;
                        } catch(e) {
                            return memoryStorage[key] || null;
                        }
                    },
                    removeItem: function(key) {
                        try {
                            localStorage.removeItem(key);
                        } catch(e) {}
                        delete memoryStorage[key];
                    }
                };
                
                // æ›¿æ¢åŸç”Ÿçš„localStorage
                window._originalLocalStorage = window.localStorage;
                Object.defineProperty(window, 'localStorage', {
                    value: safeStorage,
                    writable: false
                });
            }
        })();

        // ========== ä¸»ç¨‹åº ==========
        var colors = [];
        var projects = [];
        var editingProjectId = null;
        
        // é¡µé¢åŠ è½½æ—¶åˆå§‹åŒ–
        window.addEventListener('DOMContentLoaded', function() {
            console.log("é¡µé¢DOMåŠ è½½å®Œæˆ");
            
            // é˜²æ­¢iOSç¼©æ”¾
            document.addEventListener('touchstart', function(e) {
                if (e.touches.length > 1) {
                    e.preventDefault();
                }
            }, { passive: false });
            
            document.addEventListener('gesturestart', function(e) {
                e.preventDefault();
            });
            
            initData();
            setupEventListeners();
            loadInventory();
        });
        
        // é˜²æ­¢åŒå‡»ç¼©æ”¾
        var lastTouchEnd = 0;
        document.addEventListener('touchend', function(e) {
            var now = Date.now();
            if (now - lastTouchEnd <= 300) {
                e.preventDefault();
            }
            lastTouchEnd = now;
        }, false);
        
        // åˆå§‹åŒ–æ•°æ®
        function initData() {
            console.log("å¼€å§‹åˆå§‹åŒ–æ•°æ®");
            
            try {
                // é¢œè‰²ç³»åˆ—å®šä¹‰
                var colorSeries = {
                    'A': 26, 'B': 32, 'C': 29, 'D': 26, 'E': 24, 
                    'F': 25, 'G': 21, 'H': 23, 'M': 15
                };
                
                // å°è¯•ä»æœ¬åœ°å­˜å‚¨åŠ è½½æ•°æ®
                var savedColors = localStorage.getItem('bead_colors');
                var savedProjects = localStorage.getItem('bead_projects');
                
                console.log("åŠ è½½æœ¬åœ°å­˜å‚¨æ•°æ®:", savedColors ? "æœ‰é¢œè‰²æ•°æ®" : "æ— é¢œè‰²æ•°æ®", savedProjects ? "æœ‰é¡¹ç›®æ•°æ®" : "æ— é¡¹ç›®æ•°æ®");
                
                if (savedColors && savedColors !== 'null' && savedColors !== 'undefined' && savedColors !== '') {
                    try {
                        colors = JSON.parse(savedColors);
                        console.log("æˆåŠŸè§£æé¢œè‰²æ•°æ®ï¼Œæ•°é‡:", colors.length);
                    } catch(e) {
                        console.error("è§£æé¢œè‰²æ•°æ®å¤±è´¥ï¼Œé‡æ–°ç”Ÿæˆ:", e);
                        generateDefaultColors();
                    }
                } else {
                    console.log("æ— ä¿å­˜çš„é¢œè‰²æ•°æ®ï¼Œç”Ÿæˆé»˜è®¤æ•°æ®");
                    generateDefaultColors();
                }
                
                function generateDefaultColors() {
                    colors = [];
                    for (var series in colorSeries) {
                        for (var i = 1; i <= colorSeries[series]; i++) {
                            colors.push({
                                id: series + i,
                                series: series,
                                current: 500,
                                used: 0,
                                lastUpdate: new Date().toLocaleDateString('zh-CN')
                            });
                        }
                    }
                    saveColors();
                }
                
                if (savedProjects && savedProjects !== 'null' && savedProjects !== 'undefined' && savedProjects !== '') {
                    try {
                        projects = JSON.parse(savedProjects);
                        console.log("æˆåŠŸè§£æé¡¹ç›®æ•°æ®ï¼Œæ•°é‡:", projects.length);
                    } catch(e) {
                        console.error("è§£æé¡¹ç›®æ•°æ®å¤±è´¥:", e);
                        projects = [];
                    }
                } else {
                    projects = [];
                }
                
            } catch (e) {
                console.error("åˆå§‹åŒ–æ•°æ®æ—¶å‡ºé”™:", e);
                alert("æ•°æ®åˆå§‹åŒ–å¤±è´¥ï¼Œè¯·åˆ·æ–°é¡µé¢é‡è¯•");
                colors = [];
                projects = [];
            }
        }
        
        // è®¾ç½®äº‹ä»¶ç›‘å¬å™¨
        function setupEventListeners() {
            console.log("è®¾ç½®äº‹ä»¶ç›‘å¬å™¨");
            
            // æ ‡ç­¾é¡µåˆ‡æ¢ - ä½¿ç”¨touchå’Œclickäº‹ä»¶
            var inventoryBtn = document.getElementById('btnInventory');
            var projectBtn = document.getElementById('btnProject');
            var statsBtn = document.getElementById('btnStats');
            
            function addTabListener(btn, tabName) {
                btn.addEventListener('click', function() { switchTab(tabName); });
                btn.addEventListener('touchstart', function(e) {
                    e.preventDefault();
                    switchTab(tabName);
                });
            }
            
            addTabListener(inventoryBtn, 'inventory');
            addTabListener(projectBtn, 'project');
            addTabListener(statsBtn, 'stats');
            
            // æœç´¢åŠŸèƒ½
            var searchInput = document.getElementById('searchInput');
            searchInput.addEventListener('input', function() {
                loadInventory(this.value);
            });
            searchInput.addEventListener('touchstart', function(e) {
                e.stopPropagation();
            });
            
            // åˆ›å»ºé¡¹ç›®
            var createBtn = document.getElementById('btnCreateProject');
            createBtn.addEventListener('click', createProject);
            createBtn.addEventListener('touchstart', function(e) {
                e.preventDefault();
                createProject();
            });
            
            // æ¨¡æ€æ¡†ç‚¹å‡»å¤–éƒ¨å…³é—­
            var modal = document.getElementById('stockModal');
            modal.addEventListener('click', function(e) {
                if (e.target === this) {
                    this.style.display = 'none';
                }
            });
            
            var editModal = document.getElementById('editModal');
            editModal.addEventListener('click', function(e) {
                if (e.target === this) {
                    this.style.display = 'none';
                }
            });
            
            console.log("äº‹ä»¶ç›‘å¬å™¨è®¾ç½®å®Œæˆ");
        }
        
        // åˆ‡æ¢æ ‡ç­¾é¡µ
        function switchTab(tabName) {
            console.log("åˆ‡æ¢åˆ°æ ‡ç­¾é¡µ:", tabName);
            
            // æ›´æ–°æ ‡ç­¾æŒ‰é’®
            var buttons = document.querySelectorAll('.tab-btn');
            for (var i = 0; i < buttons.length; i++) {
                buttons[i].classList.remove('active');
            }
            document.getElementById('btn' + tabName.charAt(0).toUpperCase() + tabName.slice(1)).classList.add('active');
            
            // æ›´æ–°å†…å®¹
            var contents = document.querySelectorAll('.tab-content');
            for (var i = 0; i < contents.length; i++) {
                contents[i].classList.remove('active');
            }
            document.getElementById('tab' + tabName.charAt(0).toUpperCase() + tabName.slice(1)).classList.add('active');
            
            // æ ‡ç­¾é¡µç‰¹å®šæ“ä½œ
            if (tabName === 'inventory') {
                loadInventory();
            } else if (tabName === 'project') {
                loadColorSelection();
                loadProjectsList();
            } else if (tabName === 'stats') {
                loadStatistics();
            }
        }
        
        // åŠ è½½åº“å­˜åˆ—è¡¨
        function loadInventory(filter) {
            console.log("åŠ è½½åº“å­˜ï¼Œç­›é€‰:", filter || 'æ— ç­›é€‰');
            var container = document.getElementById('colorList');
            if (!container) {
                console.error("æ‰¾ä¸åˆ°colorListå®¹å™¨");
                return;
            }
            
            container.innerHTML = '<div class="loading">åŠ è½½ä¸­...</div>';
            
            // å»¶è¿ŸåŠ è½½ä»¥ç¡®ä¿DOMæ›´æ–°
            setTimeout(function() {
                var filteredColors = colors;
                if (filter) {
                    filteredColors = colors.filter(function(color) {
                        return color.id.toLowerCase().indexOf(filter.toLowerCase()) > -1;
                    });
                }
                
                if (filteredColors.length === 0) {
                    container.innerHTML = '<div style="text-align: center; padding: 40px; color: #999;">æœªæ‰¾åˆ°åŒ¹é…çš„é¢œè‰²</div>';
                    return;
                }
                
                var html = '';
                for (var i = 0; i < filteredColors.length; i++) {
                    var color = filteredColors[i];
                    var isLow = color.current < 300;
                    
                    html += '\
                        <div class="color-item' + (isLow ? ' low' : '') + '">\
                            <div class="color-id">' + color.id + ' (' + color.series + 'ç³»åˆ—)</div>\
                            <div class="color-info">\
                                <div>å½“å‰åº“å­˜: <strong>' + color.current + '</strong> é¢—</div>\
                                <div>å·²æ¶ˆè€—: ' + color.used + ' é¢—</div>\
                                <div>æœ€åæ›´æ–°: ' + color.lastUpdate + '</div>\
                            </div>\
                            <div class="btn-group">\
                                <button class="btn btn-add" onclick="showAddStock(\'' + color.id + '\')">è¡¥å……</button>\
                                <button class="btn btn-edit" onclick="showEditStock(\'' + color.id + '\')">ä¿®æ”¹</button>\
                                <button class="btn btn-use" onclick="showUseStock(\'' + color.id + '\')">æ¶ˆè€—</button>\
                            </div>\
                        </div>';
                }
                
                container.innerHTML = html;
                updateAlert();
            }, 50);
        }
        
        // æ›´æ–°è­¦æŠ¥
        function updateAlert() {
            var lowColors = colors.filter(function(color) {
                return color.current < 300;
            });
            
            var alertDiv = document.getElementById('stockAlert');
            var alertText = document.getElementById('alertText');
            
            if (lowColors.length > 0) {
                var colorNames = lowColors.slice(0, 3).map(function(c) { return c.id; }).join(', ');
                if (lowColors.length > 3) {
                    colorNames += ' ç­‰';
                }
                
                alertText.textContent = 'âš ï¸ æœ‰ ' + lowColors.length + ' ç§é¢œè‰²éœ€è¦è¡¥å……ï¼š' + colorNames;
                alertDiv.classList.add('show');
            } else {
                alertDiv.classList.remove('show');
            }
        }
        
        // ä¿å­˜é¢œè‰²æ•°æ®
        function saveColors() {
            try {
                localStorage.setItem('bead_colors', JSON.stringify(colors));
                console.log("é¢œè‰²æ•°æ®ä¿å­˜æˆåŠŸ");
            } catch (e) {
                console.error("ä¿å­˜é¢œè‰²æ•°æ®å¤±è´¥:", e);
                alert("ä¿å­˜æ•°æ®å¤±è´¥ï¼Œè¯·å°è¯•ä½¿ç”¨åœ¨çº¿ç‰ˆæœ¬");
            }
        }
        
        // ä¿å­˜é¡¹ç›®æ•°æ®
        function saveProjects() {
            try {
                localStorage.setItem('bead_projects', JSON.stringify(projects));
                console.log("é¡¹ç›®æ•°æ®ä¿å­˜æˆåŠŸ");
            } catch (e) {
                console.error("ä¿å­˜é¡¹ç›®æ•°æ®å¤±è´¥:", e);
            }
        }
        
        // æŸ¥æ‰¾é¢œè‰²
        function findColor(colorId) {
            for (var i = 0; i < colors.length; i++) {
                if (colors[i].id === colorId) {
                    return colors[i];
                }
            }
            return null;
        }
        
        // æ˜¾ç¤ºè¡¥å……åº“å­˜å¼¹çª—
        function showAddStock(colorId) {
            var color = findColor(colorId);
            if (!color) return;
            
            document.getElementById('modalTitle').textContent = 'è¡¥å…… ' + colorId;
            document.getElementById('modalContent').innerHTML = '\
                <div class="form-group">\
                    <div style="margin-bottom: 10px;">å½“å‰åº“å­˜: ' + color.current + ' é¢—</div>\
                    <input type="number" class="form-input" id="addQty" value="100" min="1" max="10000" placeholder="è¾“å…¥è¡¥å……æ•°é‡">\
                </div>\
                <button class="btn-primary" onclick="addStock(\'' + colorId + '\')">ç¡®è®¤è¡¥å……</button>';
            
            document.getElementById('stockModal').style.display = 'block';
        }
        
        // æ˜¾ç¤ºä¿®æ”¹åº“å­˜å¼¹çª—
        function showEditStock(colorId) {
            var color = findColor(colorId);
            if (!color) return;
            
            document.getElementById('modalTitle').textContent = 'ä¿®æ”¹ ' + colorId;
            document.getElementById('modalContent').innerHTML = '\
                <div class="form-group">\
                    <div style="margin-bottom: 10px;">å½“å‰åº“å­˜: ' + color.current + ' é¢—</div>\
                    <input type="number" class="form-input" id="newQty" value="' + color.current + '" min="0" max="10000" placeholder="è¾“å…¥æ–°æ•°é‡">\
                </div>\
                <button class="btn-primary" onclick="setStock(\'' + colorId + '\')">ç¡®è®¤ä¿®æ”¹</button>';
            
            document.getElementById('stockModal').style.display = 'block';
        }
        
        // æ˜¾ç¤ºæ¶ˆè€—åº“å­˜å¼¹çª—
        function showUseStock(colorId) {
            var color = findColor(colorId);
            if (!color) return;
            
            document.getElementById('modalTitle').textContent = 'æ¶ˆè€— ' + colorId;
            document.getElementById('modalContent').innerHTML = '\
                <div class="form-group">\
                    <div style="margin-bottom: 10px;">å½“å‰åº“å­˜: ' + color.current + ' é¢—</div>\
                    <input type="number" class="form-input" id="useQty" value="10" min="1" max="' + color.current + '" placeholder="è¾“å…¥æ¶ˆè€—æ•°é‡">\
                </div>\
                <button class="btn-primary" onclick="useStock(\'' + colorId + '\')">ç¡®è®¤æ¶ˆè€—</button>';
            
            document.getElementById('stockModal').style.display = 'block';
        }
        
        // å…³é—­å¼¹çª—
        function closeModal() {
            document.getElementById('stockModal').style.display = 'none';
        }
        
        // è¡¥å……åº“å­˜
        function addStock(colorId) {
            var input = document.getElementById('addQty');
            var qty = parseInt(input.value);
            
            if (isNaN(qty) || qty <= 0) {
                alert('è¯·è¾“å…¥æœ‰æ•ˆçš„æ•°é‡');
                return;
            }
            
            updateStock(colorId, qty, 'add');
            closeModal();
        }
        
        // è®¾ç½®åº“å­˜
        function setStock(colorId) {
            var input = document.getElementById('newQty');
            var newQty = parseInt(input.value);
            
            if (isNaN(newQty) || newQty < 0) {
                alert('è¯·è¾“å…¥æœ‰æ•ˆçš„æ•°é‡');
                return;
            }
            
            var color = findColor(colorId);
            var diff = newQty - color.current;
            updateStock(colorId, diff, 'set');
            closeModal();
        }
        
        // æ¶ˆè€—åº“å­˜
        function useStock(colorId) {
            var input = document.getElementById('useQty');
            var qty = parseInt(input.value);
            
            if (isNaN(qty) || qty <= 0) {
                alert('è¯·è¾“å…¥æœ‰æ•ˆçš„æ•°é‡');
                return;
            }
            
            var color = findColor(colorId);
            if (qty > color.current) {
                alert('åº“å­˜ä¸è¶³ï¼å½“å‰åªæœ‰ ' + color.current + ' é¢—');
                return;
            }
            
            updateStock(colorId, -qty, 'use');
            closeModal();
        }
        
        // æ›´æ–°åº“å­˜
        function updateStock(colorId, amount, type) {
            var color = findColor(colorId);
            if (!color) return;
            
            var oldStock = color.current;
            
            if (type === 'set') {
                color.current = amount;
            } else {
                color.current += amount;
                if (type === 'use') {
                    color.used += Math.abs(amount);
                }
            }
            
            color.lastUpdate = new Date().toLocaleDateString('zh-CN');
            saveColors();
            
            // åˆ·æ–°æ˜¾ç¤º
            loadInventory(document.getElementById('searchInput').value);
            
            // æ˜¾ç¤ºé€šçŸ¥
            var action = type === 'add' ? 'è¡¥å……' : type === 'use' ? 'æ¶ˆè€—' : 'è®¾ç½®';
            showMessage(action + ' ' + colorId + 'ï¼š' + oldStock + ' â†’ ' + color.current + ' é¢—');
        }
        
        // æ˜¾ç¤ºæ¶ˆæ¯
        function showMessage(message) {
            // ç§»é™¤ä¹‹å‰çš„æ¶ˆæ¯
            var oldMsg = document.querySelector('.message-notification');
            if (oldMsg) oldMsg.remove();
            
            var msg = document.createElement('div');
            msg.className = 'message-notification';
            msg.style.cssText = 'position: fixed; top: 20px; left: 50%; transform: translateX(-50%); background: #34C759; color: white; padding: 10px 20px; border-radius: 8px; z-index: 2000; box-shadow: 0 2px 10px rgba(0,0,0,0.2); font-size: 14px;';
            msg.textContent = 'âœ… ' + message;
            
            document.body.appendChild(msg);
            
            setTimeout(function() {
                if (msg.parentNode) {
                    msg.parentNode.removeChild(msg);
                }
            }, 3000);
        }
        
        // åŠ è½½é¢œè‰²é€‰æ‹©
        function loadColorSelection() {
            var container = document.getElementById('colorSelection');
            if (!container) return;
            
            container.innerHTML = '<div class="loading">åŠ è½½é¢œè‰²åˆ—è¡¨...</div>';
            
            setTimeout(function() {
                if (colors.length === 0) {
                    container.innerHTML = '<div style="text-align: center; padding: 20px; color: #999;">æš‚æ— é¢œè‰²æ•°æ®</div>';
                    return;
                }
                
                var html = '';
                for (var i = 0; i < colors.length; i++) {
                    var color = colors[i];
                    html += '\
                        <div style="display: flex; align-items: center; padding: 8px 0;">\
                            <input type="checkbox" id="check_' + color.id + '" style="margin-right: 10px;">\
                            <label for="check_' + color.id + '" style="flex: 1;">' + color.id + ' (' + color.current + 'é¢—)</label>\
                            <input type="number" id="qty_' + color.id + '" min="1" max="' + color.current + '" value="1" style="width: 60px; padding: 4px; border: 1px solid #ddd; border-radius: 4px; text-align: center;" disabled>\
                        </div>';
                }
                
                container.innerHTML = html;
                
                // é‡æ–°ç»‘å®šäº‹ä»¶
                for (var i = 0; i < colors.length; i++) {
                    var color = colors[i];
                    var checkbox = document.getElementById('check_' + color.id);
                    var qtyInput = document.getElementById('qty_' + color.id);
                    
                    if (checkbox && qtyInput) {
                        checkbox.addEventListener('change', (function(input) {
                            return function() {
                                input.disabled = !this.checked;
                            };
                        })(qtyInput));
                    }
                }
            }, 50);
        }
        
        // åˆ›å»ºé¡¹ç›®
        function createProject() {
            var name = document.getElementById('projectName').value.trim();
            var desc = document.getElementById('projectDesc').value.trim();
            
            if (!name) {
                alert('è¯·è¾“å…¥é¡¹ç›®åç§°');
                return;
            }
            
            // è·å–é€‰ä¸­çš„é¢œè‰²å’Œæ•°é‡
            var selectedColors = {};
            var hasSelection = false;
            
            for (var i = 0; i < colors.length; i++) {
                var color = colors[i];
                var checkbox = document.getElementById('check_' + color.id);
                var qtyInput = document.getElementById('qty_' + color.id);
                
                if (checkbox && checkbox.checked && qtyInput && qtyInput.value) {
                    var qty = parseInt(qtyInput.value);
                    if (!isNaN(qty) && qty > 0) {
                        selectedColors[color.id] = qty;
                        hasSelection = true;
                    }
                }
            }
            
            if (!hasSelection) {
                alert('è¯·é€‰æ‹©è‡³å°‘ä¸€ç§é¢œè‰²');
                return;
            }
            
            // æ£€æŸ¥åº“å­˜
            for (var colorId in selectedColors) {
                var color = findColor(colorId);
                if (color.current < selectedColors[colorId]) {
                    alert(colorId + ' åº“å­˜ä¸è¶³ï¼éœ€è¦ ' + selectedColors[colorId] + ' é¢—ï¼Œå½“å‰åªæœ‰ ' + color.current + ' é¢—');
                    return;
                }
            }
            
            // åˆ›å»ºé¡¹ç›®
            var project = {
                id: Date.now(),
                name: name,
                desc: desc,
                colors: selectedColors,
                date: new Date().toLocaleString('zh-CN')
            };
            
            projects.unshift(project);
            
            // æ¶ˆè€—åº“å­˜
            for (var colorId in selectedColors) {
                var color = findColor(colorId);
                color.current -= selectedColors[colorId];
                color.used += selectedColors[colorId];
                color.lastUpdate = new Date().toLocaleDateString('zh-CN');
            }
            
            // ä¿å­˜æ•°æ®
            saveColors();
            saveProjects();
            
            // é‡ç½®è¡¨å•
            document.getElementById('projectName').value = '';
            document.getElementById('projectDesc').value = '';
            loadColorSelection();
            loadProjectsList();
            updateAlert();
            
            showMessage('é¡¹ç›® "' + name + '" åˆ›å»ºæˆåŠŸï¼');
            switchTab('project');
        }
        
        // åŠ è½½é¡¹ç›®åˆ—è¡¨
        function loadProjectsList() {
            var container = document.getElementById('projectsList');
            if (!container) return;
            
            container.innerHTML = '<div class="loading">åŠ è½½é¡¹ç›®åˆ—è¡¨...</div>';
            
            setTimeout(function() {
                if (projects.length === 0) {
                    container.innerHTML = '<div style="text-align: center; padding: 40px; color: #999;">æš‚æ— é¡¹ç›®è®°å½•</div>';
                    return;
                }
                
                var html = '';
                for (var i = 0; i < projects.length; i++) {
                    var project = projects[i];
                    var colorsHtml = '';
                    
                    for (var colorId in project.colors) {
                        colorsHtml += '<span style="background: #f0f0f0; padding: 4px 8px; margin: 2px; border-radius: 4px; font-size: 12px;">' + colorId + ': ' + project.colors[colorId] + 'é¢—</span>';
                    }
                    
                    html += '\
                        <div class="project-item">\
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 5px;">\
                                <div class="project-title">' + project.name + '</div>\
                                <div>\
                                    <button onclick="editProject(' + project.id + ')" style="background: #007AFF; color: white; border: none; padding: 4px 8px; border-radius: 4px; margin-right: 5px; font-size: 12px;">ç¼–è¾‘</button>\
                                    <button onclick="deleteProject(' + project.id + ')" style="background: #FF3B30; color: white; border: none; padding: 4px 8px; border-radius: 4px; font-size: 12px;">åˆ é™¤</button>\
                                </div>\
                            </div>\
                            <div class="project-date">' + project.date + '</div>\
                            <div style="margin: 10px 0;">' + (project.desc || 'æ— æè¿°') + '</div>\
                            <div>' + colorsHtml + '</div>\
                        </div>';
                }
                
                container.innerHTML = html;
            }, 50);
        }
        
        // ç¼–è¾‘é¡¹ç›®
        function editProject(projectId) {
            var project = null;
            for (var i = 0; i < projects.length; i++) {
                if (projects[i].id === projectId) {
                    project = projects[i];
                    break;
                }
            }
            
            if (!project) return;
            
            editingProjectId = projectId;
            
            // ç”Ÿæˆç¼–è¾‘è¡¨å•
            var colorsHtml = '';
            for (var i = 0; i < colors.length; i++) {
                var color = colors[i];
                var isSelected = project.colors[color.id];
                
                colorsHtml += '\
                    <div style="display: flex; align-items: center; padding: 8px 0;">\
                        <input type="checkbox" id="edit_check_' + color.id + '" ' + 
                               (isSelected ? 'checked' : '') + ' style="margin-right: 10px;">\
                        <label for="edit_check_' + color.id + '" style="flex: 1;">' + color.id + ' (' + color.current + 'é¢—)</label>\
                        <input type="number" id="edit_qty_' + color.id + '" \
                               value="' + (isSelected ? project.colors[color.id] : 1) + '" \
                               min="1" max="' + color.current + '" style="width: 60px; padding: 4px; border: 1px solid #ddd; border-radius: 4px; text-align: center;" ' + 
                               (isSelected ? '' : 'disabled') + '>\
                    </div>';
            }
            
            document.getElementById('editContent').innerHTML = '\
                <div class="form-group">\
                    <label class="form-label">é¡¹ç›®åç§°</label>\
                    <input type="text" class="form-input" id="editName" value="' + project.name + '">\
                </div>\
                <div class="form-group">\
                    <label class="form-label">é¡¹ç›®æè¿°</label>\
                    <textarea class="form-input" id="editDesc" rows="3">' + (project.desc || '') + '</textarea>\
                </div>\
                <div class="form-group">\
                    <label class="form-label">ä¿®æ”¹ä½¿ç”¨é¢œè‰²</label>\
                    <div style="max-height: 200px; overflow-y: auto;">' + colorsHtml + '</div>\
                </div>\
                <button class="btn-primary" onclick="saveProjectEdit()">ä¿å­˜ä¿®æ”¹</button>';
            
            document.getElementById('editModal').style.display = 'block';
            
            // ç»‘å®šå¤é€‰æ¡†äº‹ä»¶
            setTimeout(function() {
                for (var i = 0; i < colors.length; i++) {
                    var color = colors[i];
                    var checkbox = document.getElementById('edit_check_' + color.id);
                    var qtyInput = document.getElementById('edit_qty_' + color.id);
                    
                    if (checkbox && qtyInput) {
                        checkbox.addEventListener('change', (function(input) {
                            return function() {
                                input.disabled = !this.checked;
                            };
                        })(qtyInput));
                    }
                }
            }, 100);
        }
        
        // ä¿å­˜é¡¹ç›®ç¼–è¾‘
        function saveProjectEdit() {
            if (!editingProjectId) return;
            
            var projectIndex = -1;
            var oldProject = null;
            
            for (var i = 0; i < projects.length; i++) {
                if (projects[i].id === editingProjectId) {
                    projectIndex = i;
                    oldProject = projects[i];
                    break;
                }
            }
            
            if (projectIndex === -1) return;
            
            var newName = document.getElementById('editName').value.trim();
            var newDesc = document.getElementById('editDesc').value.trim();
            
            if (!newName) {
                alert('è¯·è¾“å…¥é¡¹ç›®åç§°');
                return;
            }
            
            // è·å–æ–°çš„é¢œè‰²é€‰æ‹©
            var newColors = {};
            for (var i = 0; i < colors.length; i++) {
                var color = colors[i];
                var checkbox = document.getElementById('edit_check_' + color.id);
                var qtyInput = document.getElementById('edit_qty_' + color.id);
                
                if (checkbox && checkbox.checked && qtyInput && qtyInput.value) {
                    var qty = parseInt(qtyInput.value);
                    if (!isNaN(qty) && qty > 0) {
                        newColors[color.id] = qty;
                    }
                }
            }
            
            if (Object.keys(newColors).length === 0) {
                alert('è¯·é€‰æ‹©è‡³å°‘ä¸€ç§é¢œè‰²');
                return;
            }
            
            // æ¢å¤æ—§é¡¹ç›®çš„åº“å­˜
            for (var colorId in oldProject.colors) {
                var color = findColor(colorId);
                if (color) {
                    color.current += oldProject.colors[colorId];
                    color.used -= oldProject.colors[colorId];
                }
            }
            
            // åº”ç”¨æ–°é¡¹ç›®çš„åº“å­˜æ¶ˆè€—
            for (var colorId in newColors) {
                var color = findColor(colorId);
                if (color) {
                    color.current -= newColors[colorId];
                    color.used += newColors[colorId];
                    color.lastUpdate = new Date().toLocaleDateString('zh-CN');
                }
            }
            
            // æ›´æ–°é¡¹ç›®
            projects[projectIndex] = {
                id: oldProject.id,
                name: newName,
                desc: newDesc,
                colors: newColors,
                date: new Date().toLocaleString('zh-CN')
            };
            
            saveColors();
            saveProjects();
            document.getElementById('editModal').style.display = 'none';
            loadProjectsList();
            loadInventory();
            updateAlert();
            
            showMessage('é¡¹ç›®ä¿®æ”¹æˆåŠŸï¼');
        }
        
        // åˆ é™¤é¡¹ç›®
        function deleteProject(projectId) {
            if (!confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªé¡¹ç›®å—ï¼Ÿ')) {
                return;
            }
            
            var projectIndex = -1;
            var project = null;
            
            for (var i = 0; i < projects.length; i++) {
                if (projects[i].id === projectId) {
                    projectIndex = i;
                    project = projects[i];
                    break;
                }
            }
            
            if (projectIndex === -1) return;
            
            // æ¢å¤åº“å­˜
            for (var colorId in project.colors) {
                var color = findColor(colorId);
                if (color) {
                    color.current += project.colors[colorId];
                    color.used -= project.colors[colorId];
                    color.lastUpdate = new Date().toLocaleDateString('zh-CN');
                }
            }
            
            // åˆ é™¤é¡¹ç›®
            projects.splice(projectIndex, 1);
            
            saveColors();
            saveProjects();
            loadProjectsList();
            loadInventory();
            updateAlert();
            
            showMessage('é¡¹ç›®å·²åˆ é™¤ï¼Œåº“å­˜å·²æ¢å¤ï¼');
        }
        
        // åŠ è½½ç»Ÿè®¡
        function loadStatistics() {
            var totalStock = 0;
            var totalUsed = 0;
            var lowCount = 0;
            
            for (var i = 0; i < colors.length; i++) {
                totalStock += colors[i].current;
                totalUsed += colors[i].used;
                if (colors[i].current < 300) {
                    lowCount++;
                }
            }
            
            document.getElementById('statColors').textContent = colors.length;
            document.getElementById('statStock').textContent = totalStock;
            document.getElementById('statUsed').textContent = totalUsed;
            document.getElementById('statLow').textContent = lowCount;
            
            // åŠ è½½ä½åº“å­˜åˆ—è¡¨
            var lowList = document.getElementById('lowStockList');
            var lowColors = colors.filter(function(color) {
                return color.current < 300;
            });
            
            if (lowColors.length === 0) {
                lowList.innerHTML = '<div style="text-align: center; padding: 40px; color: #999;">ğŸ‰ æ‰€æœ‰åº“å­˜å……è¶³ï¼</div>';
            } else {
                var html = '';
                for (var i = 0; i < lowColors.length; i++) {
                    var color = lowColors[i];
                    html += '\
                        <div style="display: flex; justify-content: space-between; align-items: center; padding: 12px; background: #FFE5E5; border-radius: 8px; margin-bottom: 8px;">\
                            <div>\
                                <strong>' + color.id + '</strong>\
                                <div style="font-size: 12px; color: #666;">' + color.series + 'ç³»åˆ—</div>\
                            </div>\
                            <div style="text-align: right;">\
                                <div style="color: #FF3B30; font-weight: bold;">' + color.current + ' é¢—</div>\
                                <button onclick="showAddStock(\'' + color.id + '\')" style="background: #34C759; color: white; border: none; padding: 4px 8px; border-radius: 4px; margin-top: 4px; font-size: 12px;">è¡¥å……</button>\
                            </div>\
                        </div>';
                }
                lowList.innerHTML = html;
            }
        }
        
        // å…¨å±€å¯¼å‡ºå‡½æ•°
        window.switchTab = switchTab;
        window.showAddStock = showAddStock;
        window.showEditStock = showEditStock;
        window.showUseStock = showUseStock;
        window.closeModal = closeModal;
        window.addStock = addStock;
        window.setStock = setStock;
        window.useStock = useStock;
        window.createProject = createProject;
        window.editProject = editProject;
        window.saveProjectEdit = saveProjectEdit;
        window.deleteProject = deleteProject;
    </script>
</body>
</html>